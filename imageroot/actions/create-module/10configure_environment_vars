#!/usr/bin/env python3

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys
import agent
import os
import secrets

data = json.load(sys.stdin)

# === GENERATE SECURE PASSWORDS ONCE ===
def generate_random_password(length=32):
    return secrets.token_urlsafe(length)

# PostgreSQL configuration
POSTGRES_DB = data.get("POSTGRES_DB", "patchmon_db") 
POSTGRES_USER = data.get("POSTGRES_USER", "patchmon_user") 
POSTGRES_PASSWORD = data.get("POSTGRES_PASSWORD", generate_random_password())

# Save to environment so configure-module can use them
agent.set_env("POSTGRES_DB", POSTGRES_DB)
agent.set_env("POSTGRES_USER", POSTGRES_USER)
agent.set_env("POSTGRES_PASSWORD", POSTGRES_PASSWORD)

# Generate other secrets
REDIS_PASSWORD = generate_random_password()
JWT_SECRET = secrets.token_hex(64)  # 128 char hex string

agent.set_env("REDIS_PASSWORD", REDIS_PASSWORD)
agent.set_env("JWT_SECRET", JWT_SECRET)

# Write database.env for systemd
database = { 
    "POSTGRES_DB": POSTGRES_DB,
    "POSTGRES_USER": POSTGRES_USER,
    "POSTGRES_PASSWORD": POSTGRES_PASSWORD,
} 
agent.write_envfile("database.env", database)
