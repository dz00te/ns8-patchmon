#!/usr/bin/env python3

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys
import os
import secrets

# Parse input data
data = json.load(sys.stdin)

# Get state directory
state_dir = os.environ.get("AGENT_STATE_DIR", "")

# Generate hardcoded database password (TODO: generate randomly in future)
POSTGRES_PASSWORD = "G29jmyQ5t7WJiX2knN"

# Generate JWT secret for authentication
JWT_SECRET = secrets.token_urlsafe(32)

# Build database connection URL with localhost (127.0.0.1)
# Containers in the same pod share network namespace and use localhost
DATABASE_URL = f"postgresql://patchmon_user:{POSTGRES_PASSWORD}@127.0.0.1:5432/patchmon_db"

# Redis connection (localhost in pod)
REDIS_HOST = "127.0.0.1"
REDIS_PORT = "6379"

# Build CORS origin from host configuration
# Note: host validation is handled by configure-module action
host = data.get("host", "")
if host:
    if data.get("lets_encrypt"):
        CORS_ORIGIN = f"https://{host}"
    else:
        CORS_ORIGIN = f"http://{host},https://{host}"
else:
    # Default CORS for initial setup
    CORS_ORIGIN = "http://localhost:3000"

# Create database environment file
database_env = f"""POSTGRES_DB=patchmon_db
POSTGRES_PASSWORD={POSTGRES_PASSWORD}
POSTGRES_USER=patchmon_user
"""

# Create backend environment file
backend_env = f"""DATABASE_URL={DATABASE_URL}
REDIS_HOST={REDIS_HOST}
REDIS_PORT={REDIS_PORT}
JWT_SECRET={JWT_SECRET}
CORS_ORIGIN={CORS_ORIGIN}
NODE_ENV=production
"""

# Write environment files
with open(os.path.join(state_dir, 'database.env'), 'w') as f:
    f.write(database_env)

with open(os.path.join(state_dir, 'backend.env'), 'w') as f:
    f.write(backend_env)

print("Environment variables configured successfully", file=sys.stderr)
