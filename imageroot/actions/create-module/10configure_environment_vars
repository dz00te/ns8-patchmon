#!/usr/bin/env python3

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys
import agent
import secrets

# Parse input data
data = json.load(sys.stdin)

# Generate hardcoded database password (TODO: generate randomly in future)
POSTGRES_PASSWORD = "G29jmyQ5t7WJiX2knN"

# Generate JWT secret for authentication
JWT_SECRET = secrets.token_urlsafe(32)

# Build database connection URL with localhost (127.0.0.1)
# Containers in same pod share network namespace
DATABASE_URL = f"postgresql://patchmon_user:{POSTGRES_PASSWORD}@127.0.0.1:5432/patchmon_db"

# Redis connection (localhost in pod)
REDIS_HOST = "127.0.0.1"
REDIS_PORT = "6379"
REDIS_PASSWORD = ""  # No password for local Redis
REDIS_DB = "0"

# Build CORS origin from host configuration
host = data.get("host", "")
if host:
    if data.get("lets_encrypt"):
        CORS_ORIGIN = f"https://{host}"
    else:
        CORS_ORIGIN = f"http://{host},https://{host}"
else:
    CORS_ORIGIN = "http://localhost:3000"

# Create database environment file
database = {
    "POSTGRES_DB": "patchmon_db",
    "POSTGRES_PASSWORD": POSTGRES_PASSWORD,
    "POSTGRES_USER": "patchmon_user",
}
agent.write_envfile("database.env", database)

# Create backend environment file with all configuration options
backend = {
    "DATABASE_URL": DATABASE_URL,
    "REDIS_HOST": REDIS_HOST,
    "REDIS_PORT": REDIS_PORT,
    "REDIS_PASSWORD": REDIS_PASSWORD,
    "REDIS_DB": REDIS_DB,
    "JWT_SECRET": JWT_SECRET,
    "CORS_ORIGIN": CORS_ORIGIN,
    "NODE_ENV": "production",
    "LOG_LEVEL": "info",
    "SERVER_HOST": "0.0.0.0",
    "SERVER_PORT": "3001",
    "SERVER_PROTOCOL": "http",
    "DB_CONNECTION_LIMIT": "30",
    "DB_CONNECT_TIMEOUT": "10",
    "DB_POOL_TIMEOUT": "20",
    "DB_IDLE_TIMEOUT": "300",
    "DB_MAX_LIFETIME": "1800",
    "RATE_LIMIT_WINDOW_MS": "900000",
    "RATE_LIMIT_MAX": "5000",
    "AUTH_RATE_LIMIT_WINDOW_MS": "600000",
    "AUTH_RATE_LIMIT_MAX": "500",
    "AGENT_RATE_LIMIT_WINDOW_MS": "60000",
    "AGENT_RATE_LIMIT_MAX": "1000",
}
agent.write_envfile("backend.env", backend)

# Create empty redis environment file (required by redis-app.service)
redis = {}
agent.write_envfile("redis.env", redis)

# Create empty frontend environment file
frontend = {}
agent.write_envfile("frontend.env", frontend)

print("Environment variables configured successfully", file=sys.stderr)

