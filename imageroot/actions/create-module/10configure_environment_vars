#!/usr/bin/env python3

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys
import agent
import secrets

# Parse input (will be empty during create-module, that's OK)
data = json.load(sys.stdin)

# === ALLOCATE RESOURCES ===
# Allocate 1 TCP port for the web interface
tcp_ports = agent.allocate_ports(1, "tcp")
tcp_port = str(tcp_ports[0])
agent.set_env("TCP_PORT", tcp_port)

# === GENERATE SECURE PASSWORDS ===
# Use secrets module for cryptographically secure random values
postgres_password = secrets.token_urlsafe(32)
redis_password = secrets.token_urlsafe(32)
jwt_secret = secrets.token_hex(64)  # 128 characters hex

# === POSTGRESQL CONFIGURATION ===
# PatchMon uses PostgreSQL 17
postgres_db = "patchmon_db"
postgres_user = "patchmon_user"

agent.set_env("POSTGRES_DB", postgres_db)
agent.set_env("POSTGRES_USER", postgres_user)
agent.set_env("POSTGRES_PASSWORD", postgres_password)

# Build DATABASE_URL for backend
# Format: postgresql://user:password@host:port/database
database_url = f"postgresql://{postgres_user}:{postgres_password}@127.0.0.1:5432/{postgres_db}"
agent.set_env("DATABASE_URL", database_url)

# === REDIS CONFIGURATION ===
agent.set_env("REDIS_PASSWORD", redis_password)
agent.set_env("REDIS_HOST", "127.0.0.1")
agent.set_env("REDIS_PORT", "6379")
agent.set_env("REDIS_DB", "0")

# === APPLICATION SECRETS ===
agent.set_env("JWT_SECRET", jwt_secret)

# === DOCKER IMAGES ===
# Use exact versions from PatchMon docker-compose.yml
agent.set_env("POSTGRES_IMAGE", "docker.io/library/postgres:17-alpine")
agent.set_env("REDIS_IMAGE", "docker.io/library/redis:alpine")
agent.set_env("PATCHMON_BACKEND_IMAGE", "ghcr.io/patchmon/patchmon-backend:latest")
agent.set_env("PATCHMON_FRONTEND_IMAGE", "ghcr.io/patchmon/patchmon-frontend:latest")

# === APPLICATION DEFAULTS ===
# Backend runs on port 3001, frontend on 3000
agent.set_env("LOG_LEVEL", "info")
agent.set_env("SERVER_PORT", "3001")
agent.set_env("SERVER_HOST", "0.0.0.0")
agent.set_env("SERVER_PROTOCOL", "http")

# Rate limiting defaults (from PatchMon environment variables)
agent.set_env("RATE_LIMIT_WINDOW_MS", "900000")
agent.set_env("RATE_LIMIT_MAX", "5000")
agent.set_env("AUTH_RATE_LIMIT_WINDOW_MS", "600000")
agent.set_env("AUTH_RATE_LIMIT_MAX", "500")
agent.set_env("AGENT_RATE_LIMIT_WINDOW_MS", "60000")
agent.set_env("AGENT_RATE_LIMIT_MAX", "1000")

# Database pool configuration
agent.set_env("DB_CONNECTION_LIMIT", "30")
agent.set_env("DB_CONNECT_TIMEOUT", "10")
agent.set_env("DB_MAX_LIFETIME", "1800")
agent.set_env("DB_IDLE_TIMEOUT", "300")
agent.set_env("DB_POOL_TIMEOUT", "20")

# CORS - will be updated by configure-module when hostname is set
agent.set_env("CORS_ORIGIN", "http://localhost:3000")
agent.set_env("NEXT_PUBLIC_API_URL", "http://localhost:3001")
