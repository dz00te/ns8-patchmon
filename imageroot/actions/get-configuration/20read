#!/usr/bin/env python3

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

#
# Read configuration
#

import os
import sys
import json
import agent

# Prepare return variable
config = {}

# Read current configuration from the environment file
config["host"] = os.getenv("TRAEFIK_HOST","")
config["http2https"] = os.getenv("TRAEFIK_HTTP2HTTPS") == "True"
config["lets_encrypt"] = os.getenv("TRAEFIK_LETS_ENCRYPT") == "True"

# Dump the configuration to stdout
# json.dump(config, fp=sys.stdout)
if os.path.exists("database.env"): 
	data = agent.read_envfile("database.env") 
	config["POSTGRES_DB"] = data.get("POSTGRES_DB", "patchmon_db") 
	config["POSTGRES_USER"] = data.get("POSTGRES_USER", "patchmon_user") 
	config["POSTGRES_PASSWORD"] = data.get("POSTGRES_PASSWORD", "") 
else: 
	config["POSTGRES_DB"] = "patchmon_db" 
	config["POSTGRES_USER"] = "patchmon_user" 
	config["POSTGRES_PASSWORD"] = "" 
 
if os.path.exists("redis.env"): 
	data = agent.read_envfile("redis.env") 
 
if os.path.exists("backend.env"): 
	data = agent.read_envfile("backend.env") 
	config["SERVER_HOST"] = data.get("SERVER_HOST", "localhost") 
	config["DB_POOL_TIMEOUT"] = data.get("DB_POOL_TIMEOUT", "20") 
	config["LOG_LEVEL"] = data.get("LOG_LEVEL", "info") 
	config["SERVER_PORT"] = data.get("SERVER_PORT", "3000") 
	config["RATE_LIMIT_WINDOW_MS"] = data.get("RATE_LIMIT_WINDOW_MS", "900000") 
	config["RATE_LIMIT_MAX"] = data.get("RATE_LIMIT_MAX", "5000") 
	config["AUTH_RATE_LIMIT_WINDOW_MS"] = data.get("AUTH_RATE_LIMIT_WINDOW_MS", "600000") 
	config["AUTH_RATE_LIMIT_MAX"] = data.get("AUTH_RATE_LIMIT_MAX", "500") 
	config["AGENT_RATE_LIMIT_MAX"] = data.get("AGENT_RATE_LIMIT_MAX", "1000") 
	config["REDIS_HOST"] = data.get("REDIS_HOST", "redis") 
	config["JWT_SECRET"] = data.get("JWT_SECRET", "") 
	config["DB_CONNECTION_LIMIT"] = data.get("DB_CONNECTION_LIMIT", "30") 
	config["DB_CONNECT_TIMEOUT"] = data.get("DB_CONNECT_TIMEOUT", "10") 
	config["DB_MAX_LIFETIME"] = data.get("DB_MAX_LIFETIME", "1800") 
	config["REDIS_PASSWORD"] = data.get("REDIS_PASSWORD", "your-redis-password-here") 
	config["REDIS_DB"] = data.get("REDIS_DB", "0") 
	config["DATABASE_URL"] = data.get("DATABASE_URL", "postgresql://patchmon_user:REPLACE_YOUR_POSTGRES_PASSWORD_HERE@database:5432/patchmon_db") 
	config["SERVER_PROTOCOL"] = data.get("SERVER_PROTOCOL", "http") 
	config["CORS_ORIGIN"] = data.get("CORS_ORIGIN", "http://localhost:3000") 
	config["DB_IDLE_TIMEOUT"] = data.get("DB_IDLE_TIMEOUT", "300") 
	config["AGENT_RATE_LIMIT_WINDOW_MS"] = data.get("AGENT_RATE_LIMIT_WINDOW_MS", "60000") 
	config["REDIS_PORT"] = data.get("REDIS_PORT", "6379") 
else: 
	config["LOG_LEVEL"] = "info" 
	config["SERVER_PORT"] = "3000" 
	config["RATE_LIMIT_WINDOW_MS"] = "900000" 
	config["RATE_LIMIT_MAX"] = "5000" 
	config["AUTH_RATE_LIMIT_WINDOW_MS"] = "600000" 
	config["AUTH_RATE_LIMIT_MAX"] = "500" 
	config["AGENT_RATE_LIMIT_MAX"] = "1000" 
	config["REDIS_HOST"] = "redis" 
	config["JWT_SECRET"] = "" 
	config["DB_CONNECTION_LIMIT"] = "30" 
	config["DB_CONNECT_TIMEOUT"] = "10" 
	config["DB_MAX_LIFETIME"] = "1800" 
	config["REDIS_PASSWORD"] = "your-redis-password-here" 
	config["REDIS_DB"] = "0" 
	config["DATABASE_URL"] = "postgresql://patchmon_user:REPLACE_YOUR_POSTGRES_PASSWORD_HERE@database:5432/patchmon_db" 
	config["SERVER_PROTOCOL"] = "http" 
	config["CORS_ORIGIN"] = "http://localhost:3000" 
	config["DB_IDLE_TIMEOUT"] = "300" 
	config["AGENT_RATE_LIMIT_WINDOW_MS"] = "60000" 
	config["REDIS_PORT"] = "6379" 
	config["SERVER_HOST"] = "localhost" 
	config["DB_POOL_TIMEOUT"] = "20" 
 
if os.path.exists("frontend.env"): 
	data = agent.read_envfile("frontend.env") 
 
json.dump(config, fp=sys.stdout)
