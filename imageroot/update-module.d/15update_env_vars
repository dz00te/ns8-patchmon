#!/usr/bin/env python3

#
# Copyright (C) 2024 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

#
# Ensure new environment variables are present in backend.env
# after a module update. Existing values are never overwritten.
#

import os
import sys

# Default values for variables that may be missing in older installations.
# Add new entries here when future PatchMon versions require them.
DEFAULTS = {
    "TRUST_PROXY": "1",
    "ENABLE_HSTS": "true",
}

state_dir = os.environ.get("AGENT_STATE_DIR", "")
backend_env_path = os.path.join(state_dir, "backend.env")

if not os.path.exists(backend_env_path):
    print("[INFO] backend.env not found, skipping env update", file=sys.stderr)
    sys.exit(0)

# Read existing variables
env_vars = {}
with open(backend_env_path, "r") as f:
    for line in f:
        line = line.strip()
        if line and "=" in line and not line.startswith("#"):
            key, value = line.split("=", 1)
            env_vars[key] = value

# Add missing variables with defaults
added = []
for key, default_value in DEFAULTS.items():
    if key not in env_vars:
        env_vars[key] = default_value
        added.append(key)

if added:
    # Write back
    with open(backend_env_path, "w") as f:
        for key, value in env_vars.items():
            f.write(f"{key}={value}\n")
    print(f"[INFO] Added missing env vars: {', '.join(added)}", file=sys.stderr)
else:
    print("[INFO] All env vars already present, nothing to update", file=sys.stderr)
